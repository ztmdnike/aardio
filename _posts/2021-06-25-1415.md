---
title: WEBSOCKET改聊天室
---
服务端代码如下：

```
//异步服务端

import win.ui;
/*DSG{{*/
var winform = win.form(text="WebSocket单线程异步服务端演示";left=10;top=4;right=774;bottom=467)
winform.add(
button={cls="button";text="Button";left=288;top=414;right=381;bottom=453;z=2};
txtMessage={cls="edit";left=29;top=22;right=715;bottom=391;db=1;dl=1;dr=1;dt=1;edge=1;multiline=1;z=1}
)
/*}}*/

import console;
import web.socket.server;
var wsrv = web.socket.server();

//客户端使用HTTP请求切换到WebSocket协议
wsrv.onUpgradeToWebsocket = function(hSocket,request,response,protocol,origin){
    if( request.path!="/aardio"){
        //关闭应答即可拒绝请求 调用response.close()也可以
    	return response.errorStatus(404);
    }
}

//一个客户端连接过来了
grc={};
wsrv.onOpen = function(hSocket){ 
    var client = wsrv.client(hSocket);
    if(client){
        var cy=client.getRemoteIp();
        grc[cy]=hSocket;
        for(k,v in grc){
        	if(k=cy) continue;
        	wsrv.send(v,"`0"+cy+"'")
        }
    }
}

//一个客户端掉线了
wsrv.onClose = function(hSocket,event){
	winform.txtMessage.print("onClose",hSocket,event);
	var cy=wsrv.client(hSocket).getRemoteIp();
        for(k,v in grc){
        	if(k=cy) continue;
        	wsrv.send(topointer(v),"`1"+cy+"'")
        }
    
}

//一个客户端出错了
wsrv.onError = function(hSocket,err){
	winform.txtMessage.print("onError",hSocket,err);
	var cy=wsrv.client(hSocket).getRemoteIp();
        for(k,v in grc){
        	if(k=cy) continue;
        	wsrv.send(topointer(v),"`2"+cy+"'")
        }
   
}

//一个客户端发消息过来了
wsrv.onMessage = function(hSocket,msg){
    var ip=wsrv.client(hSocket).getRemoteIp();
    winform.txtMessage.print(ip,msg.data); 
    //wsrv.send(hSocket,"WebSocket客户端，收到了你发过来的消息：" + msg.data)
    var str=string.match(msg.data,"\d+\.\d+\.\d+\.\d+");
        if(str){
    	wsrv.send(grc[str],string.replace(msg.data,str,""))
    }else {
    	for(k,v in grc){
    		wsrv.send(topointer(v),ip+":  "+msg.data)
   	 }
    }
    
}

//启动服务端 
if( wsrv.start(,8876) ){
	winform.txtMessage.print( wsrv.getUrl() + "/aardio","已启动WebSocket服务器");
	winform.txtMessage.print( wsrv.httpServer.getUrl(),"已启动HTTP服务器");
}
else {
	winform.txtMessage.print("启动失败，建议修改端口号")	
}


winform.show() 
win.loopMessage();
```
客户端代码如下：
```
//异步客户端

import win.ui;
/*DSG{{*/
var winform = win.form(text="WebSocket客户端演示";right=770;bottom=467)
winform.add(
btnClose={cls="button";text="断开";left=544;top=312;right=698;bottom=350;db=1;dr=1;z=6};
btnOpen={cls="button";text="连接WebSocket服务端";left=373;top=315;right=527;bottom=353;db=1;dr=1;z=2};
btnSend={cls="button";text="发送数据";left=569;top=352;right=711;bottom=432;db=1;dr=1;z=4};
checkbox={cls="checkbox";text="列表成员发送";left=549;top=275;right=648;bottom=296;z=8};
listbox={cls="listbox";left=495;top=14;right=705;bottom=270;edge=1;items={};z=7};
txtMessage={cls="edit";left=11;top=7;right=465;bottom=278;db=1;dl=1;dr=1;dt=1;edge=1;multiline=1;z=1};
txtSend={cls="edit";text="WebSocket测试";left=29;top=376;right=558;bottom=423;db=1;dl=1;dr=1;edge=1;multiline=1;z=3};
txtUrl={cls="edit";text="ws://localhost:8876/aardio";left=28;top=324;right=367;bottom=360;db=1;dl=1;dr=1;edge=1;z=5}
)
/*}}*/

import web.socket.client;
var ws = web.socket.client();

ws.onOpen = function(){
	ws.send("服务端你好吗？！")
}

ws.onClose = function(event){
	winform.txtMessage.print("onClose",event);
}

ws.onError = function(err){
	winform.txtMessage.print("onError",err);
}

ws.onMessage = function(msg){
    //winform.txtMessage.print(msg.data); 
    var str=string.match(msg.data,"%`'")
    if(str){
    	if(tonumber(string.slice(str,1,2))){
    		for(i=1;winform.listbox.count;1){
    			if(winform.listbox.getItemText(i)=str){
    				winform.listbox.delete(i)
    			}
    		}	
    	}else {
    		winform.listbox.add(str)
    	}
    	
    }else {
    	winform.txtMessage.print(msg.data)
    }
    
}


winform.btnSend.oncommand = function(id,event){
    var str=winform.txtSend.text
    if(winform.checkbox.checked){
    	str=winform.listbox.selText + str
    }
	ws.send(str)	
}

winform.btnOpen.oncommand = function(id,event){
	ws.connect(winform.txtUrl.text);
}

winform.btnClose.oncommand = function(id,event){
	ws.close();
}

winform.txtUrl.text = "ws://172.17.32.1:8876/aardio";
ws.originUrl = "http://localhost:8876";

winform.show() 
win.loopMessage();

```
